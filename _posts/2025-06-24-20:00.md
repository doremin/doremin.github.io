---
layout: post
title: Core Animationì„ ì´ìš©í•œ Particle Animation
author: "doremin"
tags: [iOS, UIKit, Core Animation, Particle]
---

# Core Animationì„ ì´ìš©í•œ Particle Animation

Safariì˜ â€˜ë°©í•´ ìš”ì†Œ ê°€ë¦¬ê¸°(Hide Distracting Items)â€™ì²˜ëŸ¼, iOSì—ì„œ Particle Animationì„ êµ¬í˜„í•´ ë³´ê³ ì í•©ë‹ˆë‹¤.

---

## ë¯¸ë¦¬ë³´ê¸°

| CAEmitterLayer í™œìš© | UIView ë¶„í•´ ì• ë‹ˆë©”ì´ì…˜ |
|---|---|
| ![CAEmitter](/assets/images/2025-06-24/emitter.gif) | ![Disintegrate](/assets/images/2025-06-24/disintegrate.gif) |

---

## 1. CAEmitterLayerë¡œ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ê¸°

ë¹ ë¥´ê³  ì‰½ê³ , ì½”ë“œë„ ì§§ìŒ.  
ë·°ì™€ ì™„ë²½íˆ ì¼ì¹˜í•˜ì§„ ì•Šì§€ë§Œ, ê¸°ë³¸ì ì¸ íŒŒí‹°í´ íš¨ê³¼ë¥¼ ë¹ ë¥´ê²Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- í•µì‹¬ ì›ë¦¬: `CAEmitterLayer`ì™€ `CAEmitterCell`ë¡œ íŒŒí‹°í´ ë°œì‚¬  
- ì£¼ìš” ì½”ë“œ:
    ```swift
    @objc private func didTap() {
        let emitter = CAEmitterLayer()
        emitter.emitterPosition = box1.center
        emitter.emitterSize = box1.bounds.size
        emitter.emitterShape = .rectangle

        let cell = CAEmitterCell()
        cell.contents = makeSquareParticleImage(color: box1.backgroundColor?.cgColor ?? UIColor.gray.cgColor)?.cgImage
        cell.birthRate = 1000
        cell.lifetime = 1.5
        cell.velocity = 150
        cell.emissionRange = .pi * 2
        cell.alphaSpeed = -0.5

        emitter.emitterCells = [cell]
        view.layer.addSublayer(emitter)
        box1.isHidden = true

        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
            emitter.birthRate = 0
        }
    }
    ```
- **ì¥ì :** ì‰½ê³  ë¹ ë¦„, ì½”ë“œëŸ‰ ì ìŒ  
- **ë‹¨ì :** ì›ë³¸ ë·°ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì¡°ê° ì•„ë‹˜, ì‹œê°ì  ì™„ì„±ë„ëŠ” ì œí•œì 

---

## 2. UIView ë¶„í•´(Disintegrate) ì• ë‹ˆë©”ì´ì…˜

ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì—¬ëŸ¬ íƒ€ì¼ë¡œ ë¶„í•´,  
ê°ê°ì˜ ì¡°ê°ì´ ì‹¤ì œë¡œ í©ì–´ì§€ëŠ” íš¨ê³¼.  
ì‹¤ì œë¡œ Safariì˜ íš¨ê³¼ì™€ ê°€ì¥ ìœ ì‚¬í•œ ë°©ì‹.

- í•µì‹¬ ì›ë¦¬:  
    1. UIViewë¥¼ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜  
    2. ì‘ì€ íƒ€ì¼ ì´ë¯¸ì§€ë¡œ ë¶„í•   
    3. ê°ê° CALayerë¡œ ì¶”ê°€ í›„ ì• ë‹ˆë©”ì´ì…˜

- ì£¼ìš” ì½”ë“œ:
    ```swift
    extension UIView {
        func disintegrate(maxTiles: Int = 2000) {
          // UIViewì˜ snapshot image ìƒì„±
            UIGraphicsBeginImageContextWithOptions(self.bounds.size, false, UIScreen.main.scale)
            self.layer.render(in: UIGraphicsGetCurrentContext()!)
            guard let snapshotImage = UIGraphicsGetImageFromCurrentImageContext()?.cgImage else {
                UIGraphicsEndImageContext()
                return
            }
            UIGraphicsEndImageContext()

            ...
            // ì¼ì •í•œ í¬ê¸°ë¡œ ì´ë¯¸ì§€ crop
            for x in stride(from: 0, to: imageWidth, by: Int(pixelSize * scale)) {
                for y in stride(from: 0, to: imageHeight, by: Int(pixelSize * scale)) {
                    let rect = CGRect(x: x, y: y, width: Int(pixelSize * scale), height: Int(pixelSize * scale))
                    guard let tileImage = snapshotImage.cropping(to: rect) else { continue }
                    
                    let tileLayer = CALayer()
                    tileLayer.contents = tileImage
                    tileLayer.frame = CGRect(
                        x: self.frame.origin.x + CGFloat(x) / scale,
                        y: self.frame.origin.y + CGFloat(y) / scale,
                        width: pixelSize,
                        height: pixelSize
                    )

                    ...

                    // cropped imageì— ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
                    CATransaction.begin()
                    CATransaction.setCompletionBlock {
                        tileLayer.removeFromSuperlayer()
                    }
                    tileLayer.add(group, forKey: nil)
                    CATransaction.commit()
                }
            }
        }
    }
    ```
- **ì¥ì :** ì›ë³¸ ë·°ì™€ 1:1 ë§¤ì¹­ë˜ëŠ” íŒŒí‹°í´, ì™„ì„±ë„ ë†’ìŒ  
- **ë‹¨ì :** ì½”ë“œ ë³µì¡, ì„±ëŠ¥ ë¶€í•˜(ë©”ëª¨ë¦¬/CPU), ìµœì í™” í•„ìš”

---

## ì „ì²´ ì½”ë“œ ë° ìƒ˜í”Œ í”„ë¡œì íŠ¸

ğŸ‘‰ **[GitHubì—ì„œ ì „ì²´ ì½”ë“œ ë³´ê¸°](https://github.com/doremin/ParticleAnimation)**  
(ì „ì²´ ë™ì‘, ViewController, tile ë¶„í• /ì• ë‹ˆë©”ì´ì…˜ ë“± ìƒì„¸ êµ¬í˜„ í¬í•¨)

---

## ì‹¤í–‰ ê²°ê³¼ ë° ë¹„êµ
  
- CAEmitterLayerëŠ” 50000 ê°œì˜ particleì„ ìƒì„±í•´ë„ CPU, Memory ì¦ê°€ê°€ ê±°ì˜ ì—†ëŠ” ìˆ˜ì¤€.
- iPhone 16 Pro ê¸°ì¤€ 5000ê°œì˜ particleì„ ìƒì„±í•˜ë©´ ì•½ CPU 10%, Memory 50MB ë¥¼ ì°¨ì§€.

---

## ì–¸ì œ ì–´ë–¤ ë°©ì‹ì„ ì„ íƒí•´ì•¼ í• ê¹Œ?

| ìƒí™©                 | CAEmitterLayer    | UIView ë¶„í•´(Disintegrate) |
|---------------------|------------------|--------------------------|
| Particleì„ ì§ì ‘ ì¡°ì‘í•´ì•¼í•  ë•Œ     | âŒ           | âœ…       |
| 5000ê°œ ì´ìƒ íŒŒí‹°í´    | â­ï¸ (ì„±ëŠ¥ ì–‘í˜¸)    | âŒ ìµœì í™” í•„ìš”               |
| ì‚¬ì§„/ì»¬ëŸ¬ ì¼ì²´ê°      | âŒ      | â­ï¸ (ì™„ì „ ë™ì¼)              |

- ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” Metal, Scene Kit ë“± GPU ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ê³ ë ¤í•˜ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ë‹¤.

---


## ë§ˆì¹˜ë©°

ì¶”í›„ì— Metal Shaderë¥¼ ì´ìš©í•´ì„œ GPUì—ì„œ ë™ì‘í•˜ëŠ” Particle Systemì„ êµ¬í˜„í•˜ê³ ì í•©ë‹ˆë‹¤.
GPUëŠ” ë³‘ë ¬ì²˜ë¦¬ì— ìµœì í™” ë˜ì–´ìˆê¸° ë•Œë¬¸ì— Particleì˜ ê°œìˆ˜ê°€ ìˆ˜ë§Œê°œê°€ ë˜ë”ë¼ë„ ì„±ëŠ¥ì €í•˜ê°€ ì ì„ ê²ƒìœ¼ë¡œ ê¸°ëŒ€í•©ë‹ˆë‹¤.

---

## ì°¸ê³  ìë£Œ

- [Apple Docs: Core Animation Programming Guide](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/)