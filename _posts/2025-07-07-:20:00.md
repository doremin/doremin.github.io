---
layout: post
title: Metalì„ ì´ìš©í•œ Particle Animation
author: "doremin"
tags: [iOS, Metal, Particle]
---

# Metalì„ ì´ìš©í•œ Particle Animation

## ê°œìš”
ì´ ê¸€ì—ì„œëŠ” iOSì—ì„œ ëŒ€ëŸ‰ì˜ íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜ì„ íš¨ìœ¨ì ìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ì‹¤ì œ ê²½í—˜ì„ ê³µìœ í•©ë‹ˆë‹¤.  
Core Animationìœ¼ë¡œ ì‹œì‘í•´ Metalë¡œ ì „í™˜í•œ ì´ìœ , ì„±ëŠ¥ ë¹„êµ, ìë™í™” Stress Test ê²½í—˜ì„ ê³µìœ í•©ë‹ˆë‹¤.

---

## Core Animation ê¸°ë°˜ íŒŒí‹°í´ì˜ í•œê³„
[ì´ì „ì—ëŠ”](https://doremin.github.io/2025-06-24/20-00) **Core Animation**(CALayer ê¸°ë°˜)ìœ¼ë¡œ íŒŒí‹°í´ ì• ë‹ˆë©”ì´ì…˜ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
ê° íŒŒí‹°í´ì„ CALayerë¡œ ë§Œë“¤ê³ , CAAnimationìœ¼ë¡œ ì´ë™/ì•ŒíŒŒ/ìŠ¤ì¼€ì¼ ì• ë‹ˆë©”ì´ì…˜ì„ ì ìš©í•˜ëŠ” ë°©ì‹ì´ì—ˆìŠµë‹ˆë‹¤.

ê²°ê³¼ë¬¼ì€ ë§Œì¡±ìŠ¤ëŸ¬ì› ìœ¼ë‚˜, Particleì˜ ê°œìˆ˜ê°€ ë§ì•„ì§ˆ ìˆ˜ë¡ FPSê°€ ê¸‰ë½í•˜ì˜€ìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ê³  Particleì˜ ê°œìˆ˜ë¥¼ ì¤„ì´ë©´ Particleì˜ í¬ê¸°ë¥¼ í‚¤ìš¸ ìˆ˜ ë°–ì— ì—†ì–´ì„œ ì›í•˜ëŠ” ê²°ê³¼ì™€ëŠ” ê±°ë¦¬ê°€ ë©€ì–´ì¡ŒìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì´ë²ˆì—ëŠ” Core Animation ëŒ€ì‹  Metalì„ ì‚¬ìš©í•´ì„œ Particle Animationì„ êµ¬í˜„í•˜ê³ ì í•©ë‹ˆë‹¤.

---

## Metal ë„ì… ë°°ê²½
ë” ë§ì€ íŒŒí‹°í´ì„ **ëŠê¹€ ì—†ì´ ë¶€ë“œëŸ½ê²Œ** ì• ë‹ˆë©”ì´ì…˜í•˜ê³  ì‹¶ì–´ì„œ Metal ê¸°ë°˜ìœ¼ë¡œ ì „í™˜ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤.

- **ë„ì… ë°°ê²½:**  
    - ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ í•œê³„ ì²´ê°  
    - Metalì„ í†µí•´ ì–¼ë§ˆë‚˜ ì„±ëŠ¥ì´ ê°œì„ ë˜ëŠ”ì§€ ì§ì ‘ ê²€ì¦í•˜ê³  ì‹¶ì—ˆìŒ

- **Metalì˜ ì¥ì :**  
    - GPUì˜ ë³‘ë ¬ ì²˜ë¦¬ ëŠ¥ë ¥ì„ ì§ì ‘ í™œìš©  
    - Draw Call í•œ ë²ˆìœ¼ë¡œ ìˆ˜ë§Œ~ìˆ˜ì‹­ë§Œ ê°œ íŒŒí‹°í´ì„ í•œ ë²ˆì— ë Œë”ë§  
    - ë·° ê³„ì¸µ ì˜¤ë²„í—¤ë“œê°€ ì—†ìŒ
    - ë³µì¡í•œ ì»¤ìŠ¤í…€ íš¨ê³¼, ì‹¤ì‹œê°„ ë³€í™”ì— ìœ ë¦¬

---

## Metal ê¸°ë°˜ íŒŒí‹°í´ ì‹œìŠ¤í…œ êµ¬í˜„ íë¦„

1. **UIViewë¥¼ snapshot**ìœ¼ë¡œ ì´ë¯¸ì§€ ë³€í™˜  
2. ì´ë¯¸ì§€ë¥¼ íŒŒí‹°í´ ë‹¨ìœ„ë¡œ ë¶„í• , ê° íŒŒí‹°í´ ì •ë³´ë¥¼ êµ¬ì¡°ì²´ ë°°ì—´ì— ì €ì¥  
3. CPU ì—ì„œ Translate ê³„ì‚°  
4. ëª¨ë“  íŒŒí‹°í´ ì •ë³´ë¥¼ **MTLBuffer**ì— ë‹´ì•„ í•œ ë²ˆì— GPUë¡œ ì „ì†¡  
5. **Vertex/Fragment Shader**ì—ì„œ ê° íŒŒí‹°í´ì„ ê·¸ë¦¬ê¸°ë§Œ í•¨ (Draw Call 1íšŒ)  

---

## ì£¼ìš” ì½”ë“œ

### Create Particle
ì´ì „ì— Core Animationì„ ì´ìš©í–ˆë˜ ë°©ì‹ê³¼ ìœ ì‚¬í•˜ê²Œ imageë¥¼ tile sizeì— ë”°ë¼ì„œ ë¶„í•´í•œë‹¤.
ë‹¤ë¥¸ ë¶€ë¶„ì´ ìˆë‹¤ë©´ UIKitì˜ ì¢Œí‘œê³„ì™€ Metalì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¢Œí‘œê³„, ê·¸ë¦¬ê³  Textureì˜ ì¢Œí‘œê³„ê°€ ëª¨ë‘ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì´ë‹¤. ê·¸ë˜ì„œ ì¢Œí‘œê³„ë¥¼ ë³€í™˜í•´ì£¼ëŠ” ì½”ë“œë“¤ì´ ì¶”ê°€ë˜ì—ˆë‹¤.

> Projection Matrixë¥¼ ì‚¬ìš©í•˜ë©´ ì¢Œí‘œê³„ ë³€í™˜ì„ ì¼ì¼íˆ í•´ì¤„ í•„ìš”ê°€ ì—†ê¸´ í•˜ë‹¤.

| Metal ì¢Œí‘œê³„ <br> (Normalized Device Coordinate)| Texture ì¢Œí‘œê³„|
|-------|---------------------|
|![Metal Coordinate System](/assets/images/2025-07-07/NDC.png)|![Texture Coordinate](/assets/images/2025-07-07/texture.png)|

```swift
var particles: [Particle] = []

for x in 0 ..< tilesPerRow {
    for y in 0 ..< tilesPerColumn {
        // Metalì—ì„œ TextureëŠ” 0...1 ì˜ ê°’
        let textureX = Float(x) * tileSize / Float(imageWidth)
        let textureY = Float(y) * tileSize / Float(imageHeight)
        
        // í™”ë©´ìƒì˜ ì‹¤ì œ window ê¸°ì¤€ ì¢Œí‘œ
        let screenX = CGFloat(x) * CGFloat(tileSize) / scale + offsetX
        let screenY = CGFloat(y) * CGFloat(tileSize) / scale + offsetY
        
        // Metalì€ Yì¶•ì´ ìœ„ -> ì•„ë˜ë¡œ 1 â†’ -1 ì„
        let normalizedX = Float(screenX / windowWidth) * 2 - 1
        let normalizedY = 1 - Float(screenY / windowHeight) * 2
        
        // Particleì´ ì´ë™í•  ìœ„ì¹˜
        // ì „ì²´ì ìœ¼ë¡œ ìš°ìƒë‹¨ ë°©í–¥ìœ¼ë¡œ ì´ë™í•˜ì§€ë§Œ ëª¨ë‘ê°€ ì´ë™í•˜ì§€ëŠ” ì•Šê²Œ ì ì ˆí•œ ê°’ìœ¼ë¡œ..
        let dx = Float.random(in: 0.05 ... 0.1)
        let dy = Float.random(in: -0.01 ... 0.03)
        
        let particle = Particle(
            position: simd_float2(normalizedX, normalizedY),
            velocity: simd_float2(dx, dy),
            life: 1.0,
            textureCoord: simd_float2(textureX, textureY),
        )
        
        particles.append(particle)
    }
}
```

### Create Texture

Particleë¡œ ë¶„í•´í•  UIViewë¥¼ textureë¡œ ë§Œë“  í›„ fragment shaderì—ì„œ ìƒ‰ìƒ ê°’ìœ¼ë¡œ í™œìš©

```swift
private func uiImage(from view: UIView, bounds: CGRect) -> UIImage {
    let renderer = UIGraphicsImageRenderer(bounds: bounds)
    let snapshotImage = renderer.image { context in
        view.layer.render(in: context.cgContext)
    }
    
    return snapshotImage
}

private func createTexture(from image: CGImage, bounds: CGRect) -> MTLTexture? {
    guard let device else {
        return nil
    }
    
    let textureLoader = MTKTextureLoader(device: device)
    
    do {
        return try textureLoader.newTexture(cgImage: image)
    } catch {
        return nil
    }
}
```

---

## Stress Test ìë™í™”ì™€ ì„±ëŠ¥ ë¹„êµ ê²°ê³¼

íŒŒí‹°í´ ê°œìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ëŠ˜ë ¤ê°€ë©° FPS ì„ê³„ê°’(50 FPS)ì„ ì¸¡ì •í•˜ëŠ”
[Stress Test View Controller](https://github.com/doremin/MetalParticle/blob/main/MetalParticle/StressTestViewController.swift)ë¥¼ ë³„ë„ë¡œ ë§Œë“¤ì–´ ì‹¤ê¸°ê¸°(iPhone 16 Pro)ì—ì„œ ë°˜ë³µ ì¸¡ì •í–ˆìŠµë‹ˆë‹¤.

| ë°©ì‹             | FPS 50 ì´í•˜ ì„ê³„    | ì£¼ê´€ì  ì²´ê°         |
|-----------------|------------------|---------------------|
| Core Animation  | 7,000ê°œ ë¶€ê·¼       | 7,000ê°œ ì´ìƒ ë²„ë²…ì„  |
| Metal           | 16ë§Œ 7ì²œê°œ ë¶€ê·¼     | 10ë§Œ ê°œë„ ë¶€ë“œëŸ¬ì›€  |

### Time Profiler ë¹„êµ ê²°ê³¼ (Particle 30,000ê°œ)

| Core Animation   |       Metal         |
|------------------|---------------------|
| ![CoreAnimation Time Profiler](/assets/images/2025-07-07/profiler-ca.png) | ![CoreAnimation Time Profiler](/assets/images/2025-07-07/profiler-metal.png) |
| 0.3ì´ˆì˜ hang (freezing) ë°œìƒ | hang ë¯¸ë°œìƒ ë° í‰ê·  40~70% ì˜ CPU ì‚¬ìš©ë¥  |

### Animation Hitches ë¹„êµ ê²°ê³¼ (Particle 30,000ê°œ)

| Core Animation    | Metal         |
|------------------|---------------------|
| ![CoreAnimation Animation Hitches](/assets/images/2025-07-07/animation-hitches-ca.png)  | ![Metal Animation Hitches](/assets/images/2025-07-07/animation-hitches-metal.png)  |
|60FPS (16.67ms)ì— ëª»ë¯¸ì¹˜ëŠ” ì„±ëŠ¥ | 60FPS ì¶©ì¡± 

### Stress Test View Controller ì‹¤í–‰ ì˜ìƒ
![Stress Test](/assets/images/2025-07-07/stress-test.gif)

---

## Metalì„ ì‚¬ìš©í•˜ë©´ì„œ ì–´ë ¤ì› ë˜ ì 

### 1. ì¢Œí‘œê³„ ë§¤í•‘(UIKit â†” Metal NDC â†” Texture)

-	Metalì€ í™”ë©´ ì¢Œí‘œ(NDC, -1~1), UIKitì€ (0,0)~(width,height), Texture ì¢Œí‘œëŠ” (0~1) ë“± ê°ê¸° ë‹¤ë¥¸ ì¢Œí‘œê³„ë¥¼ ì‚¬ìš©í•œë‹¤.
-	íŠ¹íˆ Yì¶• ë°©í–¥ì´ UIKitì€ â€œìƒë‹¨ì´ 0, ì•„ë˜ë¡œ ì¦ê°€â€í•˜ê³ , Metal NDCëŠ” â€œì¤‘ì•™ì´ 0, ìœ„ê°€ +1, ì•„ë˜ê°€ -1â€, TextureëŠ” â€œ(0,0) ~ (1, 1)â€ ë“± í˜¼ë€ì´ ë§ì•˜ë‹¤.
-	ì¢Œí‘œê³„ë¥¼ ì˜ëª» ë§¤í•‘í•˜ë©´ íŒŒí‹°í´ì´ ì „í˜€ ì—‰ëš±í•œ ìœ„ì¹˜ì— ë³´ì´ê±°ë‚˜, í™”ë©´ì— ì•„ë¬´ê²ƒë„ ì•ˆ ë‚˜ì˜¤ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.
-	ì¢Œí‘œ ë³€í™˜ ë¡œì§ì„ ì—¬ëŸ¬ ë²ˆ ë°”ê¿”ì•¼ í–ˆê³ , ì‹¤ì œë¡œ Texture ì¢Œí‘œê°€ ë’¤ì§‘íˆê±°ë‚˜, íŒŒí‹°í´ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚˜ëŠ” ë“± ì‹œí–‰ì°©ì˜¤ë¥¼ ë§ì´ ê²ªì—ˆë‹¤.

### 2. íŒŒì´í”„ë¼ì¸/ì…°ì´ë” êµ¬ì¡°ì²´ Alignment / Size ë¬¸ì œ
-	Metalì—ì„œ Swiftì˜ êµ¬ì¡°ì²´(ì˜ˆ: Particle)ì™€ Metal ì…°ì´ë”ì˜ êµ¬ì¡°ì²´ê°€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•œë‹¤.
-	float, simd_float2, Float, float2 ë“± íƒ€ì…ì´ ë¯¸ì„¸í•˜ê²Œ ë‹¤ë¥´ê±°ë‚˜, Swiftì—ì„œ êµ¬ì¡°ì²´ì— ì¶”ê°€ í•„ë“œê°€ ìˆìœ¼ë©´ ë©”ëª¨ë¦¬êµ¬ì¡°ê°€ ë‹¬ë¼ì ¸ì„œ ì…°ì´ë”ì—ì„œ ë°ì´í„°ê°€ ê¹¨ì§.
-	ì‹œí–‰ì°©ì˜¤ ëì—, êµ¬ì¡°ì²´ ì •ì˜ëŠ” Swift/Metal ëª¨ë‘ì—ì„œ ë©¤ë²„ì™€ ìˆœì„œë¥¼ ë§ì¶° í•´ê²°í•´ì£¼ì—ˆì§€ë§Œ, ì›ì¸ì„ ì•Œê¸°ê°€ ë„ˆë¬´ë„ˆë¬´ í˜ë“¤ì—ˆë‹¤. **ì¡°ê¸ˆë§Œ ì–´ê¸‹ë‚˜ë„ Silent Error(ì—ëŸ¬ ë©”ì‹œì§€ ì—†ì´ ë™ì‘ ì•ˆ í•¨)** ê°€ ë§ì•„ ë””ë²„ê¹…ì— ì‹œê°„ ì†Œìš”ê°€ ì»¸ë‹¤.

### 3. Shader ë””ë²„ê¹… ë‚œì´ë„
-	Metal Shader ê°œë°œì—ì„œ ê°€ì¥ ë‚œì´ë„ê°€ ë†’ì€ ë¶€ë¶„ ì¤‘ í•˜ë‚˜ê°€ ë°”ë¡œ ë””ë²„ê¹…ì´ë‹¤.
-	ì»´íŒŒì¼ ì—ëŸ¬ëŠ” ê¸ˆë°© ì°¾ì§€ë§Œ, ëŸ°íƒ€ì„ì—ëŠ” ì•„ë¬´ê²ƒë„ ì•ˆ ê·¸ë ¤ì§€ê±°ë‚˜, ê°’ì´ ì´ìƒí•˜ê²Œ ë‚˜ì™€ë„ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ê±°ì˜ ì—†ë‹¤.
- ê·¸ë‚˜ë§ˆ Xcodeì˜ **Frame Capture**ë¥¼ í†µí•´ì„œ ê·¸ í”„ë ˆì„ì—ì„œ ì…°ì´ë” ì…ì¶œë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ì„œ ê·¸ë‚˜ë§ˆ ë‹¤í–‰ì´ì—ˆë‹¤.

> Computer Graphics ìˆ˜ì—…ì„ ë“¤ì–´ë©´ì„œ OpenGLì„ ì‚¬ìš©í–ˆì„ ë•Œë„ shader ë””ë²„ê¹…ì€ ì •ë§ ì •ë§ í˜ë“¤ì—ˆë˜ ê¸°ì–µì´ ìˆëŠ”ë°, ShaderëŠ” ì•„ë¬´ëŸ° ë§ë„ ì—†ì´ í™”ë©´ì— ì•„ë¬´ê²ƒë„ ì•ˆë‚˜ì˜¤ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ ë””ë²„ê¹…ì´ ì •ë§ í˜ë“  ê²ƒ ê°™ë‹¤.

---

## ê²°ë¡ 

- ì ì€ íŒŒí‹°í´/ê°„ë‹¨í•œ íš¨ê³¼ëŠ” Core Animationìœ¼ë¡œ ì¶©ë¶„
- **ìˆ˜ë§Œ ê°œ ì´ìƒ ëŒ€ëŸ‰ íŒŒí‹°í´, ê³ ì„±ëŠ¥ ì´í™íŠ¸ì—ëŠ” Metalì„ ì ê·¹ ì¶”ì²œ**
- Metalê°™ì€ Graphics LibraryëŠ” í•™ìŠµ ë‚œì´ë„ëŠ” ë†’ì§€ë§Œ íš¨ê³¼ëŠ” ì •ë§ ğŸ‘

---

ê¸€ì„ ì‘ì„±í•˜ê³  ë‚œ ì´í›„ì— position ê³„ì‚° ë¡œì§ì„ CPU -> GPUë¡œ ì˜®ê²¼ëŠ”ë° CPU ì‚¬ìš©ë¥ ì´ 10 ~ 20% ë¡œ ë” ìµœì í™”ë˜ì—ˆë‹¤. 
í•˜ì§€ë§Œ ì—¬ì „íˆ particleì„ CPUì—ì„œ ìƒì„±í•˜ëŠ” íƒ“ì— ì´ˆê¸°ì— CPU spikeê°€ ë°œìƒí•œë‹¤. 100ë§Œê°œì˜ particleë„ particle ìƒì„± ì´í›„ì—ëŠ” ë¬´ë¦¬ ì—†ì´ ë™ì‘í•˜ì§€ë§Œ ë‹¤ìŒì—ëŠ” particle ìƒì„±ë„ GPUì— ìœ„ì„í•˜ëŠ” ë°©ë²•ì„ ì°¾ì•„ë´ì•¼ í•  ê²ƒ ê°™ë‹¤.

![After Optimization](/assets/images/2025-07-07/optimization_profiler.png)

---
## ìŠ¤í¬ë¦°ìƒ·
![screenshot](/assets/images/2025-07-07/screenshot.gif)

ì „ì²´ ì½”ë“œ: [Github](https://github.com/doremin/MetalParticle)

---

## References

- [Optimizing GPU Performance](https://developer.apple.com/documentation/Xcode/Optimizing-GPU-performance)
- [Metal Shader Debugging and Profiling](https://developer.apple.com/videos/play/wwdc2018/608/)
- [Using Metal to Draw a View's Contents](https://developer.apple.com/documentation/metal/using-metal-to-draw-a-view's-contents)
- [Metal Point Cloud](https://github.com/roberthein/Metal-Point-Cloud)
